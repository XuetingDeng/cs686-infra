name: Nightly Deployment

on:
  schedule:
    - cron: '0 8 * * *'  # CA 0am
  workflow_dispatch:  # manually trigger

jobs:
  deploy-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Deploy Temporary EC2 Instance
        id: deploy
        run: |
          # Deploy an EC2 instance using AWS CLI
          INSTANCE_ID=$(aws ec2 run-instances --image-id ami-05b10e08d247fb927 --count 1 --instance-type t2.micro --key-name qa-machine-key --security-group-ids sg-06b347ae2c3e64278 --subnet-id subnet-015f9419057906f7e --query 'Instances[0].InstanceId' --output text)
          echo "Instance ID: $INSTANCE_ID"
          echo "::set-output name=instance_id::$INSTANCE_ID"

      - name: Get Public IP of EC2 Instance
        run: |
          # Get the public IP address of the newly created EC2 instance
          PUBLIC_IP=$(aws ec2 describe-instances --instance-ids ${{ steps.deploy.outputs.instance_id }} --query 'Reservations[0].Instances[0].PublicIpAddress' --output text)
          echo "EC2 Public IP: $PUBLIC_IP"
          echo "EC2_PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_ENV
      
      - name: Wait for EC2 Status Checks
        run: |
          echo "Waiting for EC2 status checks to complete..."
          aws ec2 wait instance-status-ok --instance-ids ${{ steps.deploy.outputs.instance_id }}
          echo "EC2 instance is ready."

      - name: SSH set up and connect to temp EC2
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" | base64 --decode > ~/.ssh/id_rsa
          chmod 400 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.EC2_PUBLIC_IP }} >> ~/.ssh/known_hosts
          echo "SSH key setup complete."
      
      - name: Set up Environment and Deploy Application
        run: |
          ssh -i ~/.ssh/id_rsa ec2-user@${{ env.EC2_PUBLIC_IP }} << 'EOF'
            set -e  # Exit on error

            echo "SSH connection successful!"
            echo "Updating system packages..."
            sudo yum update -y
            sudo yum install -y docker git
            sudo yum install -y libxcrypt-compat
            sudo systemctl start docker

            echo "Adding ec2-user to Docker group..."
            sudo usermod -aG docker $USER
            newgrp docker

            echo "Install JQ for JSON processing"
            sudo apt-get install -y jq

            echo "Installing Docker Compose..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            docker-compose --version || echo "Docker Compose installation failed!"

            echo "Cloning repository..."
            git clone https://github.com/XuetingDeng/crud-react-node-mySQL-go.git || (cd crud-react-node-mySQL-go && git pull)
            cd crud-react-node-mySQL-go

            docker-compose up -d
          EOF

      - name: Smoke Test
        run: |
          sleep 30  # Wait 30s for the services to be ready
          # curl http://$EC2_PUBLIC_IP:8800/books
          echo "ðŸ“Œ Fetch the books data from the API and check if there are exactly 3 books..."
          DATA=$(curl -s http://$EC2_PUBLIC_IP:8800/books)
          COUNT=$(echo $DATA | jq '. | length')
          if [ "$COUNT" -eq 3 ]; then
            echo "âœ… Smoke Test - backend & db passed: Correct number of books returned (3 books)."
          else
            echo "âŒ Smoke Test - backend & db test failed: Incorrect number of books returned."
            echo "Received data: $DATA"
            exit 1  # This will fail the workflow if the test does not pass
          fi

          echo "ðŸ“Œ Smoke Test - frontend test: should return frontend code"
          curl http://$EC2_PUBLIC_IP:5173

      - name: Get AWS Account ID
        id: aws-account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query "Account" --output text)
          echo "AWS_ACCOUNT_ID=$ACCOUNT_ID" >> $GITHUB_ENV

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Verify ECR Login
        run: |
          echo "âœ… Successfully logged in to Amazon ECR!"
          aws ecr describe-repositories --region ${{ secrets.AWS_REGION }}
  
          
      - name: Build and Tag Docker Image (Backend)
        run: |
          docker build -t $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/cs686-midterm-backend:latest -f backend/Dockerfile ./backend

      - name: Build and Tag Docker Image (Frontend)
        run: |
          docker build -t $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/cs686-midterm-frontend:latest -f frontend/Dockerfile ./frontend

      - name: Push Docker Images to Amazon ECR
        run: |
          docker push $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/cs686-midterm-backend:latest
          docker push $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/cs686-midterm-frontend:latest

      - name: Verify Images in ECR
        run: |
          echo "âœ… Verifying images in ECR..."
          aws ecr list-images --repository-name cs686-midterm-backend --region us-east-1
          aws ecr list-images --repository-name cs686-midterm-frontend --region us-east-1


      - name: Cleanup
        if: always()
        run: |
          aws ec2 terminate-instances --instance-ids ${{ steps.deploy.outputs.instance_id }}
          echo "Cleanup completed"